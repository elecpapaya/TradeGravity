# TradeGravity 설계 문서 v0.3 (Markdown)

작성일: 2026-01-19 (UTC)

## 0. 요약
각 국가(Reporter)가 미국(USA)·중국(CHN)과 거래한 **최근 무역액(수출/수입/총무역)** 을 주기적으로 수집하고, 결과를 **정적 웹페이지**로 시각화한다.  
수집/배치는 **Go 기반 자동화**로 처리하며, 프론트는 **정적 JSON + SVG** 로 렌더링한다.

핵심 시각화는 **미국(USA) / 중국(CHN) 두 개의 기준 카드(card)** 를 고정으로 두고, 각 카드 내부를 **국가별 서브 사각형(treemap)** 으로 채우는 구조다.  
각 서브 사각형의 **면적 = 해당 국가의 교역 규모**를 의미하며, 국가 수가 많아질 경우 **Top N + Others(합산)** 전략으로 가독성을 유지한다.

---

## 1. 목적
- 전 세계(또는 지정 국가 목록)의 **대미/대중 무역액 최신치**(수출/수입/총무역)를 자동 수집
- 정적 웹에서
  - 국가별 랭킹(대미/대중)
  - 국가별 시계열(USA/CHN)
  - **US–CN 카드형 Treemap(동일 국가 양쪽 동시 강조)**
  을 제공
- 데이터 갱신 지연/중단 감지 및(선택) 알림 기반 운영

---

## 2. 범위 및 정의

### 2.1 범위
- Flow: `export`, `import` (Total/Bal은 파생 계산으로 제공 가능)
- Partner: `USA`, `CHN` (고정)
- Reporter: 전세계 (Provider 목록 기반, 필요 시 allowlist로 필터)
- 수집 주기: 일 1회(권장) 또는 주 1회
- 배포: 정적 웹(HTML/CSS/JS) + 정적 데이터(JSON)

### 2.2 “최근(Latest)” 정의
- 우선순위: **월간(M) > 분기(Q) > 연간(Y)**
- 각 관측치는 `period_type`(M/Q/Y), `period`(예: 2025-11, 2025-Q4, 2025)를 포함
- 국가별 최신 period가 다를 수 있으므로 UI에서 국가별 latest period를 노출

---

## 3. 데이터 소스 및 Provider 구조

### 3.1 Provider 추상화(Go)
데이터 소스를 교체 가능하게 인터페이스로 분리한다.

- `ListReporters() -> []Reporter`
- `FetchLatest(reporter, partner, flow) -> Observation`
- `FetchSeries(reporter, partner, flow, from, to) -> []Observation`

초기 구현:
- `WITSProvider` 우선

대체/보강:
- `IMFProvider` (커버리지/최근성 필요 시)

### 3.2 Provider 선택 기준
- 파트너(USA/CHN) 기준 조회 가능
- 자동화 API 가능(쿼터/레이트리밋 대응)
- 최소 연간(Y) 커버, 가능하면 월간(M) 또는 분기(Q)

### 3.3 WITS API Notes
The WITS API does not require an API key for access.

However, there is a limit of 50,000 rows per API call. The WITS API module supports two request formats: SDMX and URL-based structures. Currently, the UNCTAD TRAINS dataset and Trade Stats are available through the API module.

For more details on using the WITS API, you can refer to the WITS API User Guide.

- WITS - API USER GUIDE
- FAQ on WITS

Disclaimer: This response was generated by an AI system based on a selected set of documents related to trade used in World Integrated Trade System (WITS). It is provided for informational purposes only and may not reflect the full scope of the topic, recent developments, or expert consensus. While efforts have been made to ensure accuracy, no warranty is given regarding completeness or reliability. Please verify all information independently before using it for business decisions, legal interpretations, or other actions. By continuing, you acknowledge that the creators are not liable for any outcomes resulting from this content.

---

## 4. 시스템 아키텍처

### 4.1 컴포넌트
1) `collector` (Go CLI)
- API 호출(레이트리밋/재시도/캐싱)
- 정규화 후 DB upsert

2) `store`
- 초기: SQLite 권장(단일 파일)
- 확장: Postgres 교체 가능

3) `publisher` (Go CLI)
- DB → 정적 JSON 생성(파생값 포함)

4) `static-site`
- 정적 HTML/CSS/JS
- **US–CN 카드형 Treemap(SVG)** + 시계열(선택)

### 4.2 배치 플로우
1. `collector run`
2. `publisher build --out=site/data`
3. CI/CD로 정적 호스팅 배포(GitHub Pages/S3/Nginx)

---

## 5. 데이터 모델(스키마)

### 5.1 테이블
- `reporters(iso3 PK, name_en, name_ko, region, is_active)`
- `partners(iso3 PK)` (USA/CHN)
- `trade_observations`
  - `provider`
  - `reporter_iso3`
  - `partner_iso3`
  - `flow` (`export`|`import`)
  - `period_type` (`M`|`Q`|`Y`)
  - `period`
  - `value_usd`
  - `ingested_at`, `source_updated_at`
- `ingest_runs(run_id PK, started_at, finished_at, status, stats_json)`

### 5.2 UNIQUE 제약(중복 방지)
- `(provider, reporter_iso3, partner_iso3, flow, period_type, period)`

---

## 6. 수집 및 정규화 전략
- 대상 국가 목록: Provider 전체 목록 후 allowlist 필터 가능 (`configs/allowlist.csv`)
- `FetchLatest` 전략:
  - 최근 N기간(예: 24개월) 조회 → 최신 period 1개 선택
  - 월간이 없으면 분기/연간으로 폴백
- 안정성:
  - 지수 백오프 + jitter 재시도
  - 토큰버킷 레이트리밋
  - 부분 실패를 허용하고 `ingest_runs`에 기록

---

## 7. 정적 산출물(JSON) 스펙

### 7.1 파일 구조
- `site/data/meta.json`
- `site/data/latest.json`
- `site/data/series/{ISO3}.json` (lazy-load)

### 7.2 latest.json 핵심 스키마(권장)
`publisher`가 **프론트 단순화를 위해** 파생값을 미리 계산해 포함한다.

각 국가 row는 다음을 포함:
- 최신 period(USA/CHN 각각 가능)
- `usa: { period, export, import, trade }`
- `chn: { period, export, import, trade }`
- `total = usa.trade + chn.trade`
- `share_cn = chn.trade / total` (total이 0이면 0 처리)
- (권장) `iso2` (국기 표시용, 없으면 프론트에서 ISO3→ISO2 매핑 테이블로 보완)

---

## 8. 정적 웹 시각화: “US–CN 카드형 Treemap” (SVG 권장)

### 8.1 목표 UX
- 화면에 **두 개의 큰 기준 카드(card)**: `USA`, `CHN` (고정 위치)
- 각 카드 내부는 **국가별 서브 사각형(treemap)** 으로 채워짐
- 서브 사각형의 **면적 = 선택한 교역 지표(trade / export / import)**
- hover 시 양쪽 카드에서 **동일 국가 동시 하이라이트**
- 검색/필터로 특정 국가 강조

### 8.2 데이터 → 레이아웃 매핑

#### 8.2.1 Treemap 면적(size)
- 기본 지표: `trade` (또는 export / import)
- 서브 사각형 면적 ∝ 지표 값
- 작은 값도 식별 가능하도록 treemap 내부 padding 적용

#### 8.2.2 Top N + Others 자동 묶기
국가 수가 증가하면 작은 사각형이 과도하게 많아져 가독성이 급격히 저하된다. 이를 방지하기 위해 **Top N + Others** 전략을 기본 적용한다.

- 선택한 지표 기준으로 **상위 N개 국가만 개별 사각형**으로 표시
- 나머지 국가는 **`Others (k)`** 하나의 사각형으로 합산 표시
  - `k` = Others에 포함된 국가 수
  - 면적 = 해당 국가들의 지표 합
- Top N 값은 UI 컨트롤로 동적 변경 가능 (예: 20~40 권장)

### 8.3 국기 표시(Flag Overlay)
- 각 국가 사각형 좌상단에 **국기 아이콘** 표시
- SVG `<image>` + 외부 CDN 사용
- 타일이 너무 작은 경우 자동으로 국기 숨김
- hover/선택 시 국기 포함 강조

---

## 9. 배포/운영

### 9.1 정적 페이지 서비스
- **GitHub Pages**를 기본 정적 호스팅으로 사용
- 대안: S3 + CloudFront, Nginx 정적 서빙
- 빌드 결과물(`site/`)을 그대로 배포하여 서버 로직 없이 서비스

### 9.2 GitHub Actions 기반 자동화
- GitHub Actions를 이용해 **데이터 수집 → 정적 페이지 갱신 → 배포**를 자동화
- 권장 주기: **매일 1회, 특정 시간(예: UTC 01:00)**

자동화 파이프라인 개요:
1. 스케줄 트리거(cron)
2. `collector` 실행 (최신 무역 데이터 수집)
3. `publisher` 실행 (JSON 및 정적 산출물 생성)
4. `site/` 디렉터리 갱신
5. GitHub Pages로 배포

스케줄 예시:
```yaml
name: Update TradeGravity

on:
  schedule:
    - cron: '0 1 * * *'  # 매일 01:00 UTC
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run collector
        run: go run ./cmd/collector

      - name: Run publisher
        run: go run ./cmd/publisher --out site/data

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${ secrets.GITHUB_TOKEN }
          publish_dir: ./site
```

### 9.3 캐시 및 운영 관점
- `meta.json`에 `generated_at` 타임스탬프 포함
- 브라우저 캐시 문제 발생 시:
  - 파일명 해시 전략 적용 또는
  - `Cache-Control: no-cache` 헤더 사용(호스팅 옵션에 따라)

### 9.4 운영 지표
- `ingest_runs.status` (success / partial / fail)
- 국가별 최신 period 분포(지연 감지)
- GitHub Actions 실패 알림(메일/Slack 연동 가능)

---

## 10. 디렉터리 구조(제안)
```
/cmd
  /collector
  /publisher
/internal
  /providers
    wits/
    imf/
  /store
  /model
  /pipeline
/site
  index.html
  app.js
  styles.css
  /data   (generated)
configs/
  allowlist.csv
```

---

## 11. 다음 작업(To-Do)
1. WITSProvider API 쿼리/응답 매핑 확정 + 레이트리밋 정책 정의
2. SQLite 마이그레이션(DDL) 및 upsert 구현
3. publisher JSON 스키마 확정(meta/latest/series) + 파생값 계산 확정(`trade_us`, `trade_cn`, `total`, `share_cn`)
4. 정적 사이트 고도화
   - Top N + Others 기본값 튜닝
   - Others 클릭 시 상세 목록 팝오버
   - region 기반 treemap 그룹핑(옵션)
   - 최근성(period lag) 시각적 경고 표시
